<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listar Posts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
      <!-- TinyMCE -->
      <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
      <script src="https://cdn.tiny.cloud/1/3cr5qahx0audqf42u7ekozi3ui571xflupyptmxfh4dapaou/tinymce/7/tinymce.min.js"
        referrerpolicy="origin"></script>
    
     <!-- JavaScript -->
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/alertify.min.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <!-- CSS -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/alertify.min.css"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
</head>
<body>
    <!-- Nuevo sidebar izquierdo -->
    <div id="left-sidebar">
        <div class="sidebar-header">
            <button id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul>
            <li>
                <a href="./crear.html" id="crearPost">
                    <i class="fas fa-plus"></i>
                    <span class="menu-text">Crear Post</span>
                </a>
            </li>
            <li>
                <a href="./index.html" id="listarPosts">
                    <i class="fas fa-list"></i>
                    <span class="menu-text">Listar Posts</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lista de Posts</h5>
                        <button class="btn btn-light" id="newPostBtn">
                            <i class="bi bi-plus-lg"></i> Nuevo Post
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="postsTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Imagen</th>
                                        <th>Título</th>
                                        <th>tipo</th>
                                        <th>Categoría</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="postsTableBody">
                                    <!-- Los datos se cargarán dinámicamente aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver el contenido -->
    <div class="modal fade" id="contentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contenido del Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="postContent"></div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Scripts necesarios -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>


    <script>;




        $(document).ready(function() {
            const spanishTranslation = {
        "decimal": "",
        "emptyTable": "No hay datos disponibles en la tabla",
        "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
        "infoEmpty": "Mostrando 0 a 0 de 0 registros",
        "infoFiltered": "(filtrado de _MAX_ registros totales)",
        "infoPostFix": "",
        "thousands": ",",
        "lengthMenu": "Mostrar _MENU_ registros",
        "loadingRecords": "Cargando...",
        "processing": "Procesando...",
        "search": "Buscar:",
        "zeroRecords": "No se encontraron registros coincidentes",
        "paginate": {
            "first": "Primero",
            "last": "Último",
            "next": "Siguiente",
            "previous": "Anterior"
        },
        "aria": {
            "sortAscending": ": activar para ordenar la columna ascendente",
            "sortDescending": ": activar para ordenar la columna descendente"
        }
    };
           
    // Inicializar DataTable
    const table = $('#postsTable').DataTable({
        language: spanishTranslation,
        order: [[5, 'desc']] // Ordenar por fecha de creación descendente
    });

    // Función para cargar publicaciones
    function loadPosts() {
        // Limpiar la tabla
        table.clear();

        // Obtener publicaciones de Firebase
        db.collection('publicaciones2')
            .orderBy('fecha_creacion', 'desc')
            .get()
            .then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const publicacion = doc.data();
                    const fecha = publicacion.fecha_creacion ? 
                        new Date(publicacion.fecha_creacion.seconds * 1000).toLocaleDateString() : 
                        'Fecha no disponible';

                    // Agregar fila a la tabla
                    table.row.add([
                        doc.id,
                        publicacion.imagen_destacada ? 
                            `<img src="${publicacion.imagen_destacada}" alt="Imagen" class="img-thumbnail" style="max-height: 50px;">` : 
                            '<span class="text-muted">Sin imagen</span>',
                        publicacion.titulo,
                        `<span class="badge bg-primary">${publicacion.categoria}</span>`,
                        publicacion.lugar || 'No especificado',
                        fecha,
                        `<div class="btn-group">
                            <button class="btn btn-sm btn-info view-content" 
                                    data-id="${doc.id}" 
                                    title="Ver">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning edit-item" 
                                    data-id="${doc.id}" 
                                    title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-item" 
                                    data-id="${doc.id}" 
                                    title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>`
                    ]).draw(false);
                });
            })
            .catch((error) => {
                console.error("Error al cargar publicaciones: ", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al cargar las publicaciones'
                });
            });
    }

    // Manejador para ver contenido
    $(document).on('click', '.view-content', function() {
        const docId = $(this).data('id');
        
        db.collection('publicaciones2').doc(docId).get()
            .then((doc) => {
                if (doc.exists) {
                    const publicacion = doc.data();
                    $('#postContent').html(`
                        <div class="mb-3">
                            <h4>${publicacion.titulo}</h4>
                            <p class="text-muted">
                                Categoría: ${publicacion.categoria}<br>
                                Lugar: ${publicacion.lugar}<br>
                                Fecha: ${new Date(publicacion.fecha_creacion.seconds * 1000).toLocaleString()}
                            </p>
                        </div>
                        <div class="content-body">
                            ${publicacion.contenido}
                        </div>
                    `);
                    $('#contentModal').modal('show');
                }
            })
            .catch((error) => {
                console.error("Error al cargar el contenido: ", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al cargar el contenido de la publicación'
                });
            });
    });

    // Manejador para eliminar
    $(document).on('click', '.delete-item', function() {
        const docId = $(this).data('id');
        
        Swal.fire({
            title: '¿Estás seguro?',
            text: "Esta acción no se puede deshacer",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                db.collection('publicaciones2').doc(docId).delete()
                    .then(() => {
                        loadPosts();
                        Swal.fire(
                            'Eliminado',
                            'La publicación ha sido eliminada',
                            'success'
                        );
                    })
                    .catch((error) => {
                        console.error("Error al eliminar: ", error);
                        Swal.fire(
                            'Error',
                            'Error al eliminar la publicación',
                            'error'
                        );
                    });
            }
        });
    });

    // Manejador para editar
    $(document).on('click', '.edit-item', function() {
        const docId = $(this).data('id');
        window.location.href = `crear.html?id=${docId}`;
    });

    // Manejador para nuevo post
    $('#newPostBtn').click(function() {
        window.location.href = 'crear.html';
    });

    // Cargar posts al iniciar
    loadPosts();
            // Nuevo post
            $('#newPostBtn').click(function() {
                window.location.href = '/crear-post.html';
            });
        });
    </script>

<script src="../js/sesion-checked.js"></script>
</body>
</html>